<?xml version="1.0" encoding="utf-8"?>
<cruise xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="cruise-config.xsd" schemaVersion="72">
  <server artifactsdir="artifacts" agentAutoRegisterKey="388b633a88de126531afa41eff9aa69e" commandRepositoryLocation="default" serverId="3c98e67f-7050-46ef-b051-fd8e63aef897" />
  <pipelines group="Doodleshop">
    <pipeline name="Build" labeltemplate="1.0.${COUNT}" isLocked="false">
      <materials>
        <git url="https://github.com/dmarell/doodleshop" />
      </materials>
      <stage name="Set_version">
        <jobs>
          <job name="mvn_set_version">
            <tasks>
              <exec command="mvn">
                <arg>versions:set</arg>
                <arg>-DnewVersion=${env.GO_PIPELINE_LABEL}</arg>
                <arg>-B</arg>
                <runif status="passed" />
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="Package" fetchMaterials="false">
        <jobs>
          <job name="mvn_clean_package">
            <tasks>
              <exec command="mvn">
                <arg>clean</arg>
                <arg>package</arg>
                <arg>-B</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="CreateDockerImage" fetchMaterials="false">
        <jobs>
          <job name="Docker_Build">
            <tasks>
              <exec command="/bin/bash">
                <arg>-c</arg>
                <arg>sudo docker build --tag=doodleshop:$GO_PIPELINE_LABEL .</arg>
                <runif status="passed" />
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="DeployToAutoSmall" fetchMaterials="false">
        <environmentvariables>
          <variable name="DOODLE_ENV">
            <value>autosmall</value>
          </variable>
        </environmentvariables>
        <jobs>
          <job name="DeployAndSmokeTests">
            <tasks>
              <exec command="bash">
                <arg>deployandsmoke.sh</arg>
                <arg>2</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="TestAutoSmall" fetchMaterials="false">
        <environmentvariables>
          <variable name="DOODLE_ENV">
            <value>autosmall</value>
          </variable>
        </environmentvariables>
        <jobs>
          <job name="RunTest">
            <tasks>
              <exec command="bash">
                <arg>runtest.sh</arg>
                <arg>2</arg>
                <runif status="passed" />
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="DeployToAutoLarge" fetchMaterials="false">
        <environmentvariables>
          <variable name="DOODLE_ENV">
            <value>autolarge</value>
          </variable>
        </environmentvariables>
        <jobs>
          <job name="DeployAndSmokeTests">
            <tasks>
              <exec command="bash">
                <arg>deployandsmoke.sh</arg>
                <arg>3</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="TestAutoLarge" fetchMaterials="false">
        <environmentvariables>
          <variable name="DOODLE_ENV">
            <value>autolarge</value>
          </variable>
        </environmentvariables>
        <jobs>
          <job name="RunTest">
            <tasks>
              <exec command="bash">
                <arg>runtest.sh</arg>
                <arg>3</arg>
                <runif status="passed" />
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="DeployToMan" fetchMaterials="false">
        <environmentvariables>
          <variable name="DOODLE_ENV">
            <value>man</value>
          </variable>
        </environmentvariables>
        <jobs>
          <job name="DeployAndSmokeTests">
            <tasks>
              <exec command="bash">
                <arg>deployandsmoke.sh</arg>
                <arg>4</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="TestMan" fetchMaterials="false">
        <environmentvariables>
          <variable name="DOODLE_ENV">
            <value>man</value>
          </variable>
        </environmentvariables>
        <jobs>
          <job name="NotifyManTest">
            <tasks>
              <exec command="bash">
                <arg>-c</arg>
                <arg>echo</arg>
                <arg>Send mail</arg>
                <runif status="passed" />
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
      <stage name="DeployToProd" fetchMaterials="false">
        <approval type="manual" />
        <environmentvariables>
          <variable name="DOODLE_ENV">
            <value>prod</value>
          </variable>
        </environmentvariables>
        <jobs>
          <job name="DeployAndSmokeTests">
            <tasks>
              <exec command="bash">
                <arg>deployandsmoke.sh</arg>
                <arg>5</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>
  </pipelines>
</cruise>
